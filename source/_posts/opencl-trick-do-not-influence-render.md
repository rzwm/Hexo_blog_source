---
title: 一个小技巧使OpenCL不影响渲染
date: 2018-07-21 23:02:35
tags: [OpenCL, GPU, render, trick]
categories: OpenCL
---

为了缩短算法在移动端的执行时间，有时我们会使用OpenCL来进行加速。OpenCL是基于命令队列的，也就是在主机端将所有要执行的命令放入队列，在设备端从队列中取出命令并执行。多数情况下，将命令放入队列只消耗极少的时间。这样一来，设备端就堆积了大量的命令需要执行，然后就会疯狂地消耗GPU资源，使得GPU资源被100%占用，造成的后果就是某些需要使用GPU进行渲染的程序严重卡顿，例如相机预览。

经过试验，我找到了一种简单的减少GPU资源占用，保证手机渲染不受影响的方法。以相机预览为例，它的刷新频率大约要保持在24Hz，那么我们就要保证在每41.7ms的时间里，其都能抢占到GPU资源进行渲染。那么我们只要保证两点就可以不影响其渲染：
1. OpenCL每个kernel的执行时间都小于41.7ms(推荐小于30ms)；
2. 在每41.7ms内，至少执行一次`clFinish()`来给予其抢占GPU资源的机会(对，技巧就是加`clFinish()`)。

可以预见的是，由于不再占用100%的GPU资源，算法的执行时间会比原来要长。
